# 要求事項

tmux の session.window.pane に対し、適切にモニタリングと指示が出せることである。

1. session の管理
  1-1. 有効なセッションの特定
  1-2. 無効なセッションの停止、session 指定でのセッション停止 `--kill-all-panes`, `--kill-all-panes --session=session_name`
2. windowに属する pane の管理
  2-1. もっともpane数の多い session.window を特定
  2-2. session.window の pane リストを管理(panes)
  2-3. paneへの役割を認識
3. panes の、稼働状態を管理（連続的な監視ループ）
  3-1. status を管理し、作業完了paneを把握、title へ反映  (per 30sec)
    3-1-1. `/clear` し claude token 節約に貢献する
    3-1-2. IDLE pane を把握
  3-2. 最新 IDLE status の pane をmain paneへ報告（新たな作業指示をさせる目的） (per 30sec)
  3-3. 自動終了、4hour 連続稼働で終了
4. 予約実行により未来時間での起動を容易にする
  4-1. HH:mm 形式で指定し、24hour 以内のみ予約可能 `--time=HH:mm`
  4-2. 指示書(instruction)を指定し、予約時間で開始した直後に読み込ませる `--instruction=<filepath>`
5. 便利ツール利用
  5-1. 全てのnodeなpaneに `/clear` を送信 --clear-all
  5-2. 全てのnodeではないpaneへ `cld` を送信し Claude起動 `--start-claude`
  5-3. 全てのnodeなpaneに コマンド送信の `Enter` を送信 `--enter-all`
  5-4. 1サイクルだけ 3 の連続処理を実行する（pane 確認とmain報告までが1サイクル）　`--onetime`

## 利用者の欲求・背景

### 根源的欲求

根源的欲求: Claude Code 稼働時間の最大化

### 判別要件

- **自動セッション発見**: 最もアクティブなtmuxセッションを自動的に選択
- **順序型役割割り当て**: pane ID数値順（%0, %1, %2...）に従い、設定値配列から上から順番に役割名を割り当て
  - 割り当て順序: `main` → `manager1` → `manager2` → `secretary` → `worker1` → `worker2`...
  - 設定値超過時: `worker{N}`形式で自動生成（Nは連番）
  - ビジネスルール: アクティブペイン（最小ID）は必ず`main`または`manager`役割を持つ
- **WorkerStatus追跡**: WORKING/IDLE/DONE/UNKNOWNの自動判定。

AI開発において、CLIツーによるコーディングを行っているが各ペインの中で動作状況が見えない。
各ペインの稼働を最大化するためにはフル稼働状態を作る必要がある。フル稼働にするためには、今現在作業が完了し、手焼き状態が生じた辺を把握する必要がある。さらに手やペインに対して新たな作業指示を出すマネージャーに状況を報告し、次のタスクを割り当てさせる必要がある。

#### サイクル

- 起動から4時間終了: 5時間程度でClaude Codeのセッションが終了するため1時間前に監視を終了する
- 30秒サイクル: 送信した指示が、入力欄に残って送信されていないケースが散見されるため、Enterで送信処理を定期実行する

#### 指示の意図

- pane の pane_title 変更: ステータスを把握するため（自動的にタイトル更新）
- main pane への報告: 空きpaneへの指示出しを行うため（ステータス変化時のみ報告）

#### 監視方式

- **パッシブ監視**: ペインに指示を送信せず、状態を監視のみ実行
- **ステータス自動判定**: ペイン内容を解析してWORKING/IDLE/DONE/UNKNOWNを判定
  - 設計: `docs/capture_state_design.md` を読む

#### 機能

- 指示書指定: main paneへの指示書を、効率よく渡すため
  - 予約実行と合わせると、指示の予約ができる

#### 中断

- キー操作での即時 monitor 停止
- panes終了指示による、panes 停止


#### メモリ効率

- **クリアコマンド実行**: DONE/IDLEペインの自動クリア
  - claude code へ `/clear` コマンドを送信、その後0.2秒待機、その後Enterを送信
  - **正しいクリア状態の定義**: 
    ```
    > /clear 
      ⎿  (no content) 
    ```
    - 比較時は、スペースや改行を取り除いて検証する
    - 上記パターン以外（`/clear`の後に`⎿  (no content)`がない、または`/clear`が連続している場合）は正しくクリアされていない
  - **クリア失敗時の復旧処理**:
    1. Escapeを送信、待機1秒
    2. Enterを送信、待機1秒  
    3. Escapeを送信、待機2秒
    4. `/clear`を再送信、待機1秒
    5. Enterを送信
  - `/clear` 送信は、workerに対してのみ送信する
- main paneへ不必要な報告を避ける（変化のないpaneステータスは送らない）

## 判別要件

- **自動セッション発見**: 最もアクティブなtmuxセッションを自動的に選択、id番号が小さい準にmain,manager1,manager2,secretary,workrs*9
- **WorkerStatus追跡**: WORKING/IDLE/DONE/UNKNOWNの自動判定
- **スケジュール実行**: Tokyo時間（`--time=HH:MM`）、直近到来する時刻
- **単発実行**: `--onetime`オプションで初回起動のみで終了

### 表示・ログ
- **リアルタイム表示**: ペイン一覧・状態・詳細情報
- **構造化ログ**: 監視プロセス・エラー・デバッグ情報
- **プログレス表示**: 監視サイクル・タイミング情報

### セキュリティ要件
- **最小権限原則**: 必要最小限のDeno権限（`--allow-run`、`--allow-read`）
- **コマンドインジェクション対策**: tmuxコマンドの適切なエスケープ
- **ファイルアクセス制限**: 指示ファイルのみの読み取り許可

### 信頼性要件
- **エラーハンドリング**: 全域性原則に基づく完全なエラー処理
- **データ整合性**: ペイン状態の一貫性保証

### 保守性要件
- **モジュール設計**: 単一責任原則による責任分離
- **依存性注入**: テスタビリティとモジュール性の確保
- **型安全性**: TypeScriptの厳密な型チェック

## 4. 技術要件

### 4.1 開発環境
- **ランタイム**: Deno 2.4.0+
- **言語**: TypeScript（厳密モード）
- **フォーマット**: Deno標準フォーマッター

### 4.2 外部依存関係
- **tmux**: システムにインストール済み
- **標準ライブラリ**: Deno標準ライブラリ優先
- **HTTPSモジュール**: ESモジュール形式

### 4.3 配布・実行
- **JSRパッケージ**: `@aidevtool/tmux-monitor`
- **CLI実行**: `deno run --allow-run jsr:@aidevtool/tmux-monitor`
- **グローバルインストール**: `deno install`対応

## 5. 制約事項

### 機能制約
- **単一セッション**: 同時に1つのtmuxセッションのみ監視
- **ペイン数制限**: 実用的な範囲（100ペイン以下）
- **ネットワーク不要**: ローカル実行のみ

## 6. 品質特性

### 6.1 設計原則
- **全域性原則**: 部分関数の全域関数化
- **型安全性**: Result型による明示的エラーハンドリング
- **単一責任**: 各コンポーネントの明確な責任分離

### 6.2 テスト要件
- **単体テスト**: 各モジュールの包括的テスト
- **統合テスト**: tmux連携の動作確認
- **エラーテスト**: 異常系のテスト

### 6.3 ドキュメント要件
- **API仕様**: 型定義とコメント
- **使用例**: CLIの例

#### 追加機能

- **Claude自動起動**: `--start-claude`フラグでClaude Code自動起動をサポート
- **CI環境対応**: GitHub Actions等のCI環境での自動実行に対応
- **ペインタイトル管理**: 監視中のタイトル変更と終了時の自動復元
- **詳細なペイン内容監視**: 30秒ごとのペイン内容変化検出とタイトル更新

#### 初期化処理

- **初回Enter送信**: 監視開始時に全ペインへの確実な送信処理を実行
- **ペイン分類**: main pane（最小ID）とtarget pane（その他）への自動分類

# tmux への Enter 送信を確実に行うこと
tmux pane の入力欄には、改行のEnterと送信のEnterの2種類がある。
明示的に使い分け、入力を確実にすること。

OK例。以下はコマンドの送信のEnterになる。
```bash
tmux send-keys -t %22 "[pane番号] 報告内容" && \
  sleep 0.1 && \
  tmux send-keys -t %22 Enter
```

NG例。以下は入力の改行のEnterになる。
```bash
tmux send-keys -t %0 "[pane番号] 報告内容" Enter
```

