# tmux-monitor ドメイン駆動設計

## 概要

tmux-monitorは、**Claude Code 稼働時間の最大化**を根源的欲求とする、tmuxターミナルセッションの監視・管理・オーケストレーションシステムです。[`docs/totality.ja.md`](./totality.ja.md)の**全域性原則**と[`docs/requirements.md`](./requirements.md)の要求事項に基づき、型安全で堅牢なドメインモデルを構築しています。

## ドメインの戦略的分析

### 🔍 **コードベース影響度分析**

現在のコードベースを24回思考パスで分析した結果、以下の要素が最も頻出し、広範囲に影響を与える**ドメインの中核**として特定されました：

| ドメイン要素 | 影響範囲 | 頻出度 | 結合度 | 戦略的重要度 |
|-------------|----------|--------|--------|------------|
| **Pane** | 15クラス | 高 | 高 | ★★★★★ |
| **WorkerStatus** | 12クラス | 高 | 中 | ★★★★☆ |
| **PaneCollection管理** | 8クラス | 中 | 高 | ★★★☆☆ |
| **MonitoringEngine協調** | 16クラス | 高 | 高 | ★★★★☆ |

### 🎯 **根源的ビジネス価値**

```
Claude Code 稼働時間の最大化
    ↓
手続き状態の即座把握（30秒サイクル）
    ↓
空きペインへの迅速なタスク割当
    ↓
フル稼働状態の維持
```

## 中核ドメイン概念

### 🎯 **Pane（ペイン）- 集約ルート**

**定義理由**: tmuxにおける「作業の最小単位」であり、Claude Codeの稼働状態を観測・制御する**境界**そのものである。

**なぜPaneが集約ルートなのか**:
1. **一意性の保証**: tmux内でPaneIDは絶対的に一意であり、他のエンティティの識別基盤となる
2. **状態の一貫性**: タイトル・ステータス・履歴・名前は、すべて「同一ペインの異なる側面」であり、分離すると整合性が失われる
3. **ビジネス不変条件**: 「稼働中ペインへのタスク割当禁止」「履歴保持上限」などの制約は、ペイン単位でのみ意味を持つ
4. **操作の原子性**: ステータス変更→タイトル更新→履歴記録は、途中で分割できない単一の業務操作

**ドメイン境界**:
- **含む**: ID、メタデータ、状態、ステータス、履歴、名前（ペインの本質的属性）
- **含まない**: tmuxコマンド実行、ネットワーク通信、ファイルI/O（技術的関心事）

**不変条件**:
- PaneIDはtmux形式（%\d+）でなければならない
- ステータス遷移は定義されたルールに従う
- 履歴は最大2件まで保持
- アクティブペインは1セッションに1つのみ

#### 🔑 **PaneId（値オブジェクト）**

**定義理由**: tmuxシステムが生成する識別子の制約を型レベルで表現し、不正な値の流入を防ぐため。

**なぜ値オブジェクトなのか**: IDは交換不可能で不変であり、同値性は値そのもので決まる本質的特性を持つ。

**制約の根拠**: tmuxの仕様（%数字形式）に従い、システム間の整合性を保証する。

#### 🏷️ **PaneName（値オブジェクト）**

**定義理由**: ペインの役割（manager、worker、secretary）を表現する業務上の識別子。

**なぜこの制約なのか**: Claude Codeの作業分類に基づく。managerは統制、workerは実行、secretaryは補助という明確な役割分担がある。

**パターンの根拠**: 運用上の命名規則を型で強制し、間違った分類を防ぐ。

### 📊 **WorkerStatus（値オブジェクト）**

**定義理由**: Claude Codeの稼働状況という「観測可能な事実」を表現する。

**なぜこの状態分割なのか**:
- **IDLE**: タスク割当可能な状態（ビジネス上最重要）
- **WORKING**: 作業実行中（監視継続が必要）
- **BLOCKED**: 外部要因による停止（介入判断が必要）
- **DONE**: 作業完了（クリア処理対象）
- **TERMINATED**: 異常終了（調査が必要）
- **UNKNOWN**: 判定不能（デフォルト状態）

**状態遷移の制約**: 業務フローに従った論理的な遷移のみを許可し、不整合を防ぐ。

### 🔄 **MonitoringCycle（値オブジェクト）**

**定義理由**: 監視業務の「周期性」と「段階性」を型で表現する。

**なぜこの設計なのか**: 
- **依存関係の明示**: 各フェーズの前提条件を型で表現
- **失敗の分離**: 段階ごとの失敗を独立して処理
- **並行性の制御**: 同時実行可能な操作を制限

## アーキテクチャ層構造

### 🏛️ **4層アーキテクチャの選択理由**

```
Presentation Layer  → CLI Interface, Application Controller
Domain Layer        → Core Models, Smart Constructors, Business Rules
Application Layer   → MonitoringEngine (orchestration)
Infrastructure Layer → TmuxSession, CommandExecutor, PaneCommunicator
```

**なぜこの分離なのか**:
- **関心の分離**: 各層が単一の責任を持つ
- **依存方向**: 上位層は下位層に依存するが、逆は禁止
- **テスタビリティ**: ドメイン層は外部依存なしでテスト可能
- **保守性**: 技術変更がドメインロジックに影響しない

## ユビキタス言語辞書

### 📚 **中核概念**

| 用語 | 定義 | なぜこの用語なのか |
|------|------|-------------------|
| **Pane** | tmuxの作業ペイン（%1, %2...形式ID） | tmux標準用語との一致、技術者の直感的理解 |
| **Main Pane** | アクティブな操作対象ペイン | 「メイン」は操作者視点の自然な表現 |
| **Target Panes** | 監視対象の非アクティブペイン群 | 「ターゲット」は監視対象を示す明確な表現 |
| **Session Discovery** | 最適tmuxセッションの自動発見 | 「ディスカバリー」は自動検出の意味を含む |
| **Status Tracking** | ペイン状況の継続的追跡 | 「トラッキング」は継続性を含意する |
| **Monitoring Cycle** | 監視の1周期（発見→分類→追跡→報告） | 「サイクル」は周期性と段階性を表現 |

### ⚙️ **技術用語**

| 用語 | 設計原則 | なぜこの用語なのか |
|------|----------|-------------------|
| **Smart Constructor** | 制約付きオブジェクト生成 | 「スマート」は制約の存在を示唆 |
| **Result Type** | 型安全なエラーハンドリング | 関数型プログラミングの標準用語 |
| **Discriminated Union** | 状態の型安全表現 | TypeScriptの公式用語 |

## 論理的全域性の設計原則

### 🧠 **核心理念**

**部分関数を全域関数に変換**し、型システムで「ありえない状態」を排除。

**なぜ全域性が重要なのか**:
1. **予測可能性**: すべての入力に対して定義された出力がある
2. **堅牢性**: 例外的状況も型レベルで表現される
3. **保守性**: 新しい状態追加時にコンパイラが網羅性をチェック
4. **テスタビリティ**: すべてのパスが明示的にテスト可能

### 🛡️ **実践パターンの選択理由**

#### **パターン1: Discriminated Union**
**なぜこのパターンなのか**: 
- オプショナル型では「なぜその状態なのか」が不明
- switch文でコンパイラが網羅性を保証
- 新しい状態追加時に既存コードの修正箇所が明確

#### **パターン2: Smart Constructor**
**なぜこのパターンなのか**:
- 不正値の作成を型レベルで防止
- ビジネスルールがオブジェクト作成時に強制される
- Result型により失敗理由が明示的

#### **パターン3: Result型**
**なぜこのパターンなのか**:
- 例外は呼び出し側が予期しづらい
- エラー処理の網羅性をコンパイラが保証
- 失敗の型情報により適切な対処が可能

## 設計品質指標

### 📊 **全域性メトリクス**

| 指標 | 目標値 | 測定理由 |
|------|-------|----------|
| **型カバレッジ** | any型使用率 < 1% | 型安全性の定量化 |
| **パターン網羅** | switch文default不要率 100% | 状態網羅性の保証 |
| **エラー型化** | 例外使用率 < 5% | エラーハンドリングの明示性 |
| **制約型化** | ビジネスルール型表現率 95% | 不変条件の強制度 |

## まとめ

### 🎯 **設計原則の統合**

tmux-monitorのドメインモデルは以下の理念で統合されています：

1. **Pane中心設計**: 業務の最小単位を型で表現
2. **状態の明示性**: すべての状態遷移が予測可能
3. **制約の型化**: ビジネスルールをコンパイル時に強制
4. **失敗の型安全性**: エラーも型システムの一部として扱う

### 🏗️ **型システムによるビジネス論理保証**

**論理的全域性**により、従来の手続き型では困難だった**ビジネスロジックの完全性**を型レベルで保証。tmux環境での複雑なペイン管理を**予測可能で保守しやすい**コードベースで実現します。

**なぜこの設計なのか**: Claude Code稼働時間の最大化という目標を、技術的負債を生まずに持続可能な形で実現するため。
