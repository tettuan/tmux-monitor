# tmux-monitor テスト実行ガイド

このドキュメントは、tmux-monitorアプリケーションの包括的なテストを実行するためのガイドです。
Domain-Driven Design (DDD) とイベント駆動アーキテクチャの実装を検証します。

## 📋 テスト実行手順

### 前提条件

```bash
# tmuxが実行中であることを確認
tmux list-sessions

# 複数のペインが存在することを確認
tmux list-panes -a

# Denoプロジェクトのセットアップ確認
cd /Users/tettuan/github/tmux-monitor
deno --version
```

## 🎯 テストケース一覧

### 1. 基本機能テスト

#### 1.1 単発監視モード（--onetime）

**実行コマンド:**
```bash
timeout 30s deno task start --onetime
```

**成功の定義:**
- [ ] tmuxペインが正常に検出される
- [ ] ペインの状態（IDLE/WORKING/DONE/UNKNOWN）が正しく抽出される
- [ ] 監視が1サイクルで終了する
- [ ] 統計情報が正確に表示される
- [ ] エラーなく終了する（終了コード: 0）

**検証ポイント:**
```
✅ 期待する出力例:
[INFO] Discovered X panes from tmux
[INFO] 🎯 Initial state: X total panes, Y working, Z idle
✅ Pane %N self-updated: STATUS → STATUS
```

#### 1.2 継続監視モード（デフォルト）

**実行コマンド:**
```bash
timeout 60s deno task start
```

**成功の定義:**
- [ ] 継続的な監視ループが動作する
- [ ] 各サイクルでペインの状態が更新される
- [ ] イベント駆動アーキテクチャが正常に動作する
- [ ] メモリリークが発生しない
- [ ] タイムアウトで正常終了する

**検証ポイント:**
```
✅ 期待する出力例:
[INFO] 📊 Cycle N (Phase): X status changes
🔍 DEBUG: Extracting status from title: "..."
✅ Pane %N self-updated: OLD_STATUS → NEW_STATUS
```

### 2. 時間指定実行テスト

#### 2.1 現在時刻+1分後の指定

**実行コマンド:**
```bash
# 現在時刻+1分を計算して実行
NEXT_TIME=$(date -d '+1 minute' '+%H:%M')
timeout 120s deno task start --time=$NEXT_TIME --onetime
```

**成功の定義:**
- [ ] スケジュール時刻まで待機する
- [ ] 指定時刻に監視が開始される
- [ ] Tokyo時間で正確に実行される
- [ ] 単発実行で終了する

#### 2.2 過去時刻指定（翌日実行）

**実行コマンド:**
```bash
timeout 10s deno task start --time=23:59 --onetime
```

**成功の定義:**
- [ ] 過去時刻が翌日として解釈される
- [ ] 適切なスケジュール情報が表示される
- [ ] タイムアウトで正常終了する

### 3. 指示書実行テスト

#### 3.1 指示書ファイル作成と実行

**準備:**
```bash
# テスト用指示書作成
cat > tmp/test_instruction.txt << 'EOF'
# テスト用指示書
echo "Hello from instruction file"
ls -la
pwd
EOF
```

**実行コマンド:**
```bash
timeout 60s deno task start --instruction=tmp/test_instruction.txt --onetime
```

**成功の定義:**
- [ ] 指示書ファイルが正常に読み込まれる
- [ ] 指示内容がターゲットペインに送信される
- [ ] ファイルが存在しない場合のエラーハンドリングが正常

#### 3.2 時間指定 + 指示書の組み合わせ

**実行コマンド:**
```bash
FUTURE_TIME=$(date -d '+30 seconds' '+%H:%M')
timeout 90s deno task start --time=$FUTURE_TIME --instruction=tmp/test_instruction.txt --onetime
```

**成功の定義:**
- [ ] 指定時刻まで待機
- [ ] 時刻到達後に指示書が実行される
- [ ] 組み合わせオプションが正常に動作する

### 4. ペイン管理テスト

#### 4.1 ペイン一覧表示

**実行コマンド:**
```bash
timeout 30s deno task start --list-panes
```

**成功の定義:**
- [ ] 全ペインが一覧表示される
- [ ] 各ペインの詳細情報が表示される
- [ ] アクティブペインが識別される
- [ ] ペイン名が正確に割り当てられる

#### 4.2 ペインクリア機能

**実行コマンド:**
```bash
timeout 30s deno task start --clear --onetime
```

**成功の定義:**
- [ ] 対象ペインがクリアされる
- [ ] メイン操作ペインが保護される
- [ ] 安全に実行される

### 5. エラーハンドリングテスト

#### 5.1 不正なオプション

**実行コマンド:**
```bash
timeout 10s deno task start --invalid-option 2>&1 | head -20
```

**成功の定義:**
- [ ] 適切なエラーメッセージが表示される
- [ ] ヘルプ情報が表示される
- [ ] 異常終了する（終了コード: 1）

#### 5.2 存在しない指示書ファイル

**実行コマンド:**
```bash
timeout 10s deno task start --instruction=/nonexistent/file.txt --onetime 2>&1
```

**成功の定義:**
- [ ] ファイル不存在エラーが適切に処理される
- [ ] 分かりやすいエラーメッセージが表示される
- [ ] アプリケーションがクラッシュしない

### 6. パフォーマンステスト

#### 6.1 多数ペイン環境でのテスト

**実行コマンド:**
```bash
# 複数ペインを作成してテスト
timeout 45s deno task start --onetime
```

**成功の定義:**
- [ ] 10個以上のペインを正常に処理する
- [ ] レスポンス時間が許容範囲内（<5秒）
- [ ] メモリ使用量が適切
- [ ] すべてのペインが漏れなく監視される

#### 6.2 長時間実行テスト

**実行コマンド:**
```bash
timeout 300s deno task start
```

**成功の定義:**
- [ ] 5分間の継続実行が安定している
- [ ] メモリリークが発生しない
- [ ] CPU使用率が適切
- [ ] 定期的な統計情報が出力される

## 🧪 CI/CDテスト

### 7.1 自動テスト実行

**実行コマンド:**
```bash
timeout 120s deno task test
```

**成功の定義:**
- [ ] 全247テストが成功する
- [ ] テスト実行時間が許容範囲内
- [ ] カバレッジが維持される

### 7.2 コード品質チェック

**実行コマンド:**
```bash
timeout 60s deno task ci:dirty
```

**成功の定義:**
- [ ] 型チェックが成功する
- [ ] JSR互換性チェックが成功する
- [ ] リンティングが成功する
- [ ] フォーマットチェックが成功する
- [ ] 全5段階のCIステージが成功する

## 📊 総合評価基準

### ✅ 成功基準（PASS）

以下の条件をすべて満たす場合、実装は成功とみなす：

1. **機能完全性**
   - [ ] 全基本機能が正常動作する
   - [ ] オプションの組み合わせが正しく処理される
   - [ ] エラーハンドリングが適切に動作する

2. **アーキテクチャ準拠**
   - [ ] DDDの集約ルート（Pane）が正常に機能する
   - [ ] イベント駆動アーキテクチャが実装されている
   - [ ] ドメイン境界が適切に維持されている

3. **品質保証**
   - [ ] 全自動テストが成功する
   - [ ] CI/CDパイプラインが成功する
   - [ ] コード品質基準を満たす

4. **パフォーマンス**
   - [ ] 応答時間が許容範囲内
   - [ ] メモリ使用量が適切
   - [ ] 長時間実行が安定している

5. **ユーザビリティ**
   - [ ] 直感的なコマンドライン操作
   - [ ] 分かりやすいログ出力
   - [ ] 適切なエラーメッセージ

### 🔧 総合評価実行

**最終評価コマンド:**
```bash
# 全テストケースの自動実行スクリプト例
cat > test_all.sh << 'EOF'
#!/bin/bash
set -e

echo "🚀 tmux-monitor 総合テスト開始"
echo "================================"

# 基本機能テスト
echo "📋 1. 基本機能テスト"
timeout 30s deno task start --onetime
echo "✅ 単発監視テスト完了"

# CI/CDテスト
echo "📋 2. CI/CDテスト"
timeout 120s deno task ci:dirty
echo "✅ CI/CDテスト完了"

# 自動テスト
echo "📋 3. 自動テスト実行"
timeout 120s deno task test
echo "✅ 自動テスト完了"

echo "🎉 全テスト完了！"
EOF

chmod +x test_all.sh
timeout 300s ./test_all.sh
```

### 📈 評価レポート作成

テスト完了後、以下の形式で評価レポートを作成してください：

```markdown
# tmux-monitor テスト評価レポート

## 実行日時
- 実行日: $(date)
- 実行環境: $(uname -a)
- Deno版本: $(deno --version)

## テスト結果サマリー
- 実行テストケース数: X/Y
- 成功率: X%
- 所要時間: X分

## 各テストケース結果
1. 基本機能テスト: ✅/❌
2. 時間指定実行テスト: ✅/❌
3. 指示書実行テスト: ✅/❌
4. ペイン管理テスト: ✅/❌
5. エラーハンドリングテスト: ✅/❌
6. パフォーマンステスト: ✅/❌
7. CI/CDテスト: ✅/❌

## 問題と改善点
- 発見された問題: [記載]
- 改善提案: [記載]

## 総合評価
- 全体評価: 合格/不合格
- 推奨アクション: [記載]
```

## 🎯 実行指示

このテストガイドを使用して以下を実行してください：

1. **段階的テスト実行**: 各テストケースを順番に実行し、結果を記録
2. **問題の特定**: 失敗したテストケースの原因を分析
3. **パフォーマンス測定**: 実行時間とリソース使用量を監視
4. **総合評価**: 全テスト完了後に総合的な品質評価を実施
5. **改善提案**: 発見された問題に対する具体的な改善案を提示

**重要**: タイムアウトを適切に設定し、無限ループや異常な長時間実行を防止してください。
