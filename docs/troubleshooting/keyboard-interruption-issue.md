# ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å‰²ã‚Šè¾¼ã¿å•é¡Œã¨è§£æ±ºæ–¹æ³•

## å•é¡Œã®æ¦‚è¦

tmux-monitor ã®ç›£è¦–ã‚µã‚¤ã‚¯ãƒ«å®Ÿè¡Œä¸­ã«ã€ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›ï¼ˆCtrl+Cã‚„ä»»æ„ã®ã‚­ãƒ¼ï¼‰ã«ã‚ˆã‚‹ä¸­æ–­ãŒåŠ¹ã‹ãªã„å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç›£è¦–ã‚’åœæ­¢ã—ãŸãã¦ã‚‚ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒåå¿œã›ãšç¶™ç¶šã—ã¦ã—ã¾ã†çŠ¶æ…‹ã§ã—ãŸã€‚

## å•é¡Œã®ç—‡çŠ¶

- ç›£è¦–ã‚µã‚¤ã‚¯ãƒ«é–‹å§‹å¾Œã€Ctrl+Cã‚’æŠ¼ã—ã¦ã‚‚ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒåœæ­¢ã—ãªã„
- ä»»æ„ã®ã‚­ãƒ¼å…¥åŠ›ã‚‚æ¤œçŸ¥ã•ã‚Œãªã„
- macOSã§ã¯Cmd+Wã§ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã‚‹ã“ã¨ã¯ã§ãã‚‹ãŒã€æ­£å¸¸ãªä¸­æ–­ã§ã¯ãªã„
- ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’è¦‹ã‚‹ã¨ã€ã‚­ãƒ¼ãƒªã‚¹ãƒŠãƒ¼ãŒèµ·å‹•ç›´å¾Œã«çµ‚äº†ã—ã¦ã„ãŸ

## æ ¹æœ¬åŸå› 

### 1. åˆæœŸåŒ–é †åºã®å•é¡Œ

`KeyboardInterruptHandler.setup()` ãƒ¡ã‚½ãƒƒãƒ‰ã«ãŠã„ã¦ã€çŠ¶æ…‹ç®¡ç†ã®åˆæœŸåŒ–é †åºã«å•é¡ŒãŒã‚ã‚Šã¾ã—ãŸï¼š

```typescript
// å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰
async setup(): Promise<Result<void, ServiceError>> {
  if (this.state.kind !== "uninitialized") {
    // ...
  }
  
  // ã‚­ãƒ¼ãƒªã‚¹ãƒŠãƒ¼ã‚’é–‹å§‹ï¼ˆã“ã®æ™‚ç‚¹ã§stateã¯ã¾ã "uninitialized"ï¼‰
  const listenerPromise = this.startKeyListener();
  
  // ãã®å¾Œã§çŠ¶æ…‹ã‚’æ›´æ–°
  this.state = { kind: "initialized", listener: listenerPromise };
}
```

`startKeyListener()` ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ã¯ä»¥ä¸‹ã®ãƒã‚§ãƒƒã‚¯ãŒã‚ã‚Šã¾ã™ï¼š

```typescript
private async startKeyListener(): Promise<void> {
  this._logger.debug(`Starting key listener (state: ${this.state.kind})`);
  
  if (this.state.kind !== "initialized") {
    this._logger.debug("State not initialized, exiting listener");
    return;
  }
  // ...
}
```

ã¤ã¾ã‚Šã€`startKeyListener()` ãŒå‘¼ã°ã‚ŒãŸæ™‚ç‚¹ã§ `state.kind` ãŒ `"uninitialized"` ã®ãŸã‚ã€å³åº§ã«ãƒªã‚¿ãƒ¼ãƒ³ã—ã¦ã—ã¾ã„ã€å®Ÿéš›ã®ã‚­ãƒ¼å…¥åŠ›ç›£è¦–ãƒ«ãƒ¼ãƒ—ãŒé–‹å§‹ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚

### 2. ç›£è¦–ãƒ«ãƒ¼ãƒ—ã§ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ä¸è¶³

åˆæœŸã®å®Ÿè£…ã§ã¯ã€ç›£è¦–ãƒ«ãƒ¼ãƒ—å†…ã§ `globalCancellationToken` ã®çŠ¶æ…‹ã‚’é©åˆ‡ã«ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã¾ã›ã‚“ã§ã—ãŸï¼š

```typescript
// å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰
while (cycleCount < maxCycles) {
  // ç›£è¦–å‡¦ç†...
  await new Promise(resolve => setTimeout(resolve, nextCycleDelay));
}
```

ã“ã®å®Ÿè£…ã§ã¯ã€`setTimeout` ã«ã‚ˆã‚‹å¾…æ©Ÿä¸­ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒç™ºç”Ÿã—ã¦ã‚‚ã€ãã‚Œã‚’æ¤œçŸ¥ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚

## è§£æ±ºæ–¹æ³•

### 1. åˆæœŸåŒ–é †åºã®ä¿®æ­£

çŠ¶æ…‹ã‚’å…ˆã«ã€Œinitializedã€ã«æ›´æ–°ã—ã¦ã‹ã‚‰ã€ã‚­ãƒ¼ãƒªã‚¹ãƒŠãƒ¼ã‚’é–‹å§‹ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£ï¼š

```typescript
async setup(): Promise<Result<void, ServiceError>> {
  // ã¾ãšçŠ¶æ…‹ã‚’ initialized ã«æ›´æ–°
  this.state = { kind: "initialized", listener: null };
  
  // stdin ã®è¨­å®š
  if (Deno.stdin.isTerminal()) {
    try {
      Deno.stdin.setRaw(true);
      // çŠ¶æ…‹ãŒæ›´æ–°ã•ã‚ŒãŸå¾Œã§ãƒªã‚¹ãƒŠãƒ¼ã‚’é–‹å§‹
      const listenerPromise = this.startKeyListener();
      // ãƒªã‚¹ãƒŠãƒ¼ã®Promiseã§çŠ¶æ…‹ã‚’æ›´æ–°
      this.state = { kind: "initialized", listener: listenerPromise };
    } catch (error) {
      // ã‚¨ãƒ©ãƒ¼å‡¦ç†...
    }
  }
}
```

### 2. ã‚­ãƒ£ãƒ³ã‚»ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œã®ç›£è¦–ãƒ«ãƒ¼ãƒ—

`globalCancellationToken` ã‚’ä½¿ç”¨ã—ãŸä¸­æ–­å¯èƒ½ãªé…å»¶å‡¦ç†ã‚’å®Ÿè£…ï¼š

```typescript
while (cycleCount < maxCycles && !globalCancellationToken.isCancelled()) {
  // ç›£è¦–å‡¦ç†...
  
  // ã‚­ãƒ£ãƒ³ã‚»ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¯èƒ½ãªé…å»¶
  const interrupted = await globalCancellationToken.delay(result.nextCycleDelay);
  if (interrupted) {
    this._logger.info("ğŸ›‘ Monitoring interrupted by user");
    break;
  }
}
```

### 3. å³åº§ã®çµ‚äº†å‡¦ç†

`forceExit()` ãƒ¡ã‚½ãƒƒãƒ‰ã§é…å»¶ãªãå³åº§ã«çµ‚äº†ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£ï¼š

```typescript
forceExit(code: number = 0): void {
  this._logger.debug(`Force exit requested with code ${code}`);
  Deno.exit(code);  // setTimeoutã‚’å‰Šé™¤
}
```

## æ½œåœ¨çš„ãªå•é¡Œã¨å¯¾å‡¦æ³•

### 1. ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ç’°å¢ƒã®é•ã„

**å•é¡Œ**: ç•°ãªã‚‹ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ç’°å¢ƒã§ raw mode ã®å‹•ä½œãŒç•°ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

**å¯¾å‡¦æ³•**:
- `Deno.stdin.isTerminal()` ã§ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ç’°å¢ƒã‚’ãƒã‚§ãƒƒã‚¯
- raw mode ãŒè¨­å®šã§ããªã„å ´åˆã¯ã€ã‚·ã‚°ãƒŠãƒ«ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ã¿ã«ä¾å­˜
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã§ graceful degradation ã‚’å®Ÿè£…

### 2. éåŒæœŸå‡¦ç†ã®ç«¶åˆçŠ¶æ…‹

**å•é¡Œ**: è¤‡æ•°ã®éåŒæœŸå‡¦ç†ï¼ˆã‚­ãƒ¼ãƒªã‚¹ãƒŠãƒ¼ã€ã‚·ã‚°ãƒŠãƒ«ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã€ç›£è¦–ãƒ«ãƒ¼ãƒ—ï¼‰ãŒä¸¦è¡Œã—ã¦å‹•ä½œã™ã‚‹ãŸã‚ã€ç«¶åˆçŠ¶æ…‹ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

**å¯¾å‡¦æ³•**:
- çŠ¶æ…‹ç®¡ç†ã‚’ atomic ã«è¡Œã†
- `globalCancellationToken` ã‚’å˜ä¸€ã®çœŸå®Ÿã®æƒ…å ±æºã¨ã—ã¦ä½¿ç”¨
- cleanup å‡¦ç†ã§å…¨ã¦ã®éåŒæœŸå‡¦ç†ã®çµ‚äº†ã‚’ä¿è¨¼

### 3. stdin ã®ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°

**å•é¡Œ**: `Deno.stdin.read()` ã¯ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°æ“ä½œã®ãŸã‚ã€ä»–ã®å‡¦ç†ã‚’å¦¨ã’ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

**å¯¾å‡¦æ³•**:
- ç‹¬ç«‹ã—ãŸéåŒæœŸã‚¿ã‚¹ã‚¯ã¨ã—ã¦ã‚­ãƒ¼ãƒªã‚¹ãƒŠãƒ¼ã‚’å®Ÿè¡Œ
- Promise.race() ã‚’ä½¿ç”¨ã—ã¦è¤‡æ•°ã®çµ‚äº†æ¡ä»¶ã‚’ç›£è¦–
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®šã—ã¦ç„¡é™å¾…æ©Ÿã‚’é˜²ã

### 4. ãƒªã‚½ãƒ¼ã‚¹ãƒªãƒ¼ã‚¯

**å•é¡Œ**: raw mode ã®è¨­å®šã‚„éåŒæœŸãƒªã‚¹ãƒŠãƒ¼ãŒé©åˆ‡ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã•ã‚Œãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

**å¯¾å‡¦æ³•**:
```typescript
cleanup(): void {
  this._logger.debug("Cleaning up KeyboardInterruptHandler");
  
  // raw mode ã‚’å¿…ãšãƒªã‚»ãƒƒãƒˆ
  if (Deno.stdin.isTerminal()) {
    try {
      Deno.stdin.setRaw(false);
    } catch (error) {
      this._logger.error("Failed to reset terminal", error);
    }
  }
  
  // çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
  this.state = { kind: "uninitialized" };
}
```

### 5. ãƒ‡ãƒãƒƒã‚°ã®å›°é›£ã•

**å•é¡Œ**: éåŒæœŸå‡¦ç†ã¨ã‚¿ãƒ¼ãƒŸãƒŠãƒ«åˆ¶å¾¡ãŒçµ¡ã‚€ãŸã‚ã€å•é¡Œã®åŸå› ç‰¹å®šãŒå›°é›£ã§ã™ã€‚

**å¯¾å‡¦æ³•**:
- è©³ç´°ãªãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’å®Ÿè£…ï¼ˆLOG_LEVEL=debugï¼‰
- å„çŠ¶æ…‹é·ç§»ã§ãƒ­ã‚°å‡ºåŠ›
- ãƒ†ã‚¹ãƒˆç”¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¦å•é¡Œã‚’åˆ†é›¢

## ãƒ†ã‚¹ãƒˆæ–¹æ³•

å•é¡Œã®å†ç¾ã¨ä¿®æ­£ã®ç¢ºèªã®ãŸã‚ã€ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ï¼š

1. **test_direct_stdin.ts**: åŸºæœ¬çš„ãªstdinèª­ã¿å–ã‚Šãƒ†ã‚¹ãƒˆ
2. **test_stdin_blocking.ts**: éåŒæœŸstdinå‡¦ç†ã®ãƒ†ã‚¹ãƒˆ
3. **test_key_listener.ts**: rawãƒ¢ãƒ¼ãƒ‰ã§ã®ã‚­ãƒ¼å…¥åŠ›æ¤œå‡ºãƒ†ã‚¹ãƒˆ
4. **test_monitor_interruption.ts**: å®Ÿéš›ã®ç›£è¦–ãƒ«ãƒ¼ãƒ—ã§ã®ä¸­æ–­ãƒ†ã‚¹ãƒˆ

## ã¾ã¨ã‚

ã“ã®å•é¡Œã¯ã€éåŒæœŸå‡¦ç†ã®åˆæœŸåŒ–é †åºã¨ã„ã†åŸºæœ¬çš„ãªãƒŸã‚¹ãŒåŸå› ã§ã—ãŸãŒã€ä»¥ä¸‹ã®é‡è¦ãªæ•™è¨“ã‚’å¾—ã¾ã—ãŸï¼š

1. **çŠ¶æ…‹ç®¡ç†ã®é‡è¦æ€§**: éåŒæœŸå‡¦ç†ã§ã¯ã€çŠ¶æ…‹ã®æ›´æ–°ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒ critical
2. **ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã®ä¾¡å€¤**: é©åˆ‡ãªãƒ­ã‚°ãŒã‚ã‚Œã°å•é¡Œã®ç‰¹å®šãŒå®¹æ˜“
3. **ãƒ†ã‚¹ãƒˆã®åˆ†é›¢**: è¤‡é›‘ãªå•é¡Œã¯å°ã•ãªãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã«åˆ†è§£ã—ã¦æ¤œè¨¼
4. **Graceful degradation**: æ§˜ã€…ãªç’°å¢ƒã§ã®å‹•ä½œã‚’æƒ³å®šã—ãŸå®Ÿè£…

ä»Šå¾ŒåŒæ§˜ã®å•é¡Œã‚’é˜²ããŸã‚ã€éåŒæœŸå‡¦ç†ã®åˆæœŸåŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç¢ºç«‹ã—ã€ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚